# 功能規範：MCP (Model Context Protocol) 支援

**功能分支**：`002-mcp-support`
**建立日期**：2025-12-07
**狀態**：草稿
**輸入**：使用者描述：我想將目前專案增加支援MCP的功能

**語言**：本文件及所有 `/speckit` 產出必須使用正體中文撰寫

## 用戶情景與測試 *(必須)*

### 用戶故事 1 - MCP 伺服器基礎功能（優先級：P1）

系統提供 MCP 伺服器功能,讓 AI 助手能夠透過 MCP 協定連接並使用 YouTube 搜尋服務。

**為何此優先級**：這是 MCP 整合的核心功能。沒有基礎的 MCP 伺服器,其他進階功能都無法實現。這是最小可行產品(MVP)的基礎。

**獨立測試**：可以透過標準 MCP 客戶端(如 Claude Desktop)連接到伺服器,執行基本的搜尋工具調用,並收到正確格式的回應。這可以獨立於其他功能進行測試和展示。

**接受情景**：

1. **當** MCP 客戶端嘗試連接伺服器 **則** 伺服器成功建立連接並回應協定握手
2. **當** MCP 客戶端請求可用工具列表 **則** 伺服器返回所有已註冊的搜尋工具及其描述
3. **當** MCP 客戶端調用搜尋工具 **則** 伺服器執行搜尋並以 MCP 標準格式返回結果
4. **當** 連接中斷 **則** 伺服器優雅地關閉並釋放資源

---

### 用戶故事 2 - YouTube 搜尋工具整合（優先級：P1）

MCP 伺服器提供 YouTube 搜尋工具,讓 AI 助手能夠透過自然語言指令搜尋影片並獲取詳細 metadata。

**為何此優先級**：這是 MCP 功能的核心價值。將現有的 YouTube 搜尋 API 功能封裝為 MCP 工具是整個功能的主要目的,提供 AI 助手與搜尋服務的橋接。

**獨立測試**：可以透過 MCP 客戶端直接調用 YouTube 搜尋工具,傳入關鍵字,驗證返回的影片資訊格式正確且包含必要的 metadata。無需依賴其他 MCP 功能即可完整測試此工具。

**接受情景**：

1. **當** AI 助手調用 youtube_search 工具並傳入關鍵字 **則** 返回符合的影片清單及其 metadata
2. **當** 調用時指定結果數量限制 **則** 返回的影片數量不超過指定限制
3. **當** 調用時指定排序方式 **則** 結果按照指定方式排序(相關性或日期)
4. **當** 搜尋無結果 **則** 返回空清單並附帶說明訊息
5. **當** 參數無效 **則** 返回清楚的錯誤訊息說明問題

---

### 用戶故事 3 - 工具參數驗證與錯誤處理（優先級：P2）

MCP 工具提供完整的參數驗證,並在發生錯誤時返回有意義的錯誤訊息,幫助 AI 助手理解問題並調整請求。

**為何此優先級**：提升使用體驗和穩定性。在 P1 功能建立後,P2 確保工具能夠優雅處理各種異常情況,讓 AI 助手能夠自我修正。

**獨立測試**：可以獨立測試各種無效參數組合(空關鍵字、超出範圍的 limit、無效的 sort_by 等),驗證每種情況都返回適當的錯誤訊息。

**接受情景**：

1. **當** 傳入空白關鍵字 **則** 返回錯誤訊息說明關鍵字不能為空
2. **當** limit 參數超出允許範圍 **則** 返回錯誤訊息說明有效範圍
3. **當** sort_by 參數不在允許的選項中 **則** 返回錯誤訊息列出有效選項
4. **當** YouTube 服務暫時無法使用 **則** 返回錯誤訊息說明服務狀態並建議稍後重試
5. **當** 快取服務故障 **則** 降級到直接搜尋並記錄警告

---

### 用戶故事 4 - MCP 伺服器配置管理（優先級：P3 - 後續迭代）

提供簡單的配置機制,讓使用者能夠自訂 MCP 伺服器的行為,如連接埠、快取設定、日誌級別等。

**為何此優先級**：這是便利性功能。初期版本使用合理的預設值（MCP_SEARCH_TIMEOUT=15秒，MCP_SEARCH_RETRIES=3次）快速交付，P3 在後續迭代中提供更好的可配置性。

**獨立測試**：可以透過修改配置檔案,驗證伺服器啟動時採用新的設定,如不同的連接埠或日誌級別。

**接受情景**：

1. **當** 配置檔案指定自訂連接埠 **則** 伺服器在該連接埠啟動
2. **當** 配置檔案指定日誌級別 **則** 伺服器採用該級別進行日誌記錄
3. **當** 配置檔案無效 **則** 伺服器使用預設配置並記錄警告
4. **當** 未提供配置檔案 **則** 伺服器使用合理的預設值正常啟動

**注意**：此功能在 MVP 中使用環境變數進行基本超時和重試配置，完整的配置檔案支援延後到後續迭代。

---

### Edge Cases

- 當 MCP 客戶端在搜尋過程中斷開連接時,系統如何處理?
- 當同時有多個 MCP 客戶端連接時,系統如何管理資源?
- 當搜尋返回非常大的結果集時,如何避免超出 MCP 訊息大小限制?
- 當 YouTube 網站結構改變導致爬蟲失效時,如何通知使用者?
- 當 Redis 快取服務不可用時,MCP 工具是否仍能正常運作?
- 當關鍵字包含特殊字符或不同語言文字時,如何確保正確處理?

## 需求 *(必須)*

### 功能需求

- **FR-001**: 系統必須提供符合 MCP 協定標準的伺服器實作，透過 StreamableHTTPSessionManager 與 FastAPI 整合
- **FR-002**: 系統必須在 MCP 伺服器啟動時自動註冊所有可用的搜尋工具，提供可擴展的工具框架以支援未來的新工具
- **FR-003**: 系統必須提供 youtube_search 工具，接受關鍵字、結果數量限制、排序方式作為參數
- **FR-004**: 系統必須將現有 YouTube 搜尋 API 的功能完整映射到 MCP 工具，不使用 YouTube Data API，維持爬蟲方式實現
- **FR-005**: 系統必須在 MCP 工具回應中包含影片的完整 metadata(video_id、標題、頻道、URL 等)
- **FR-006**: 系統必須驗證所有 MCP 工具調用的參數有效性
- **FR-007**: 系統必須在參數無效時返回描述性錯誤訊息
- **FR-008**: 系統必須在搜尋服務發生錯誤時優雅降級，避免整個 MCP 伺服器崩潰
- **FR-009**: 系統必須記錄所有 MCP 工具調用和錯誤到日誌系統
- **FR-010**: 系統必須支援透過環境變數進行超時和重試配置：MCP_SEARCH_TIMEOUT（預設 15 秒）和 MCP_SEARCH_RETRIES（預設 3 次）
- **FR-011**: 系統必須在 MCP 工具描述中清楚說明每個參數的用途和限制
- **FR-012**: 系統必須確保 MCP 回應格式符合協定規範，可被標準 MCP 客戶端解析

### 關鍵實體

- **MCP 伺服器**: 實作 Model Context Protocol 的伺服器程序,負責接收來自 AI 助手的請求並調用相應的工具
- **YouTube 搜尋工具**: MCP 工具實例,封裝了 YouTube 搜尋功能,包含工具名稱、描述、參數定義和執行邏輯
- **工具參數**: 定義 MCP 工具接受的輸入,包括關鍵字(必填)、結果數量限制(選填,預設 1)、排序方式(選填,預設相關性)
- **工具回應**: MCP 工具執行後返回的結果,包含影片清單或錯誤訊息,符合 MCP 協定格式
- **連接會話**: MCP 客戶端與伺服器之間的連接實例,維護通訊狀態和上下文

## 成功標準 *(必須)*

### 可衡量結果

- **SC-001**: AI 助手能夠在 5 秒內成功連接到 MCP 伺服器並獲取工具列表
- **SC-002**: AI 助手調用 YouTube 搜尋工具的成功率達到 95% 以上(排除 YouTube 服務本身的問題)
- **SC-003**: MCP 工具返回的搜尋結果與直接調用 REST API 的結果一致性達到 100%
- **SC-004**: 系統能夠同時支援至少 10 個並發 MCP 客戶端連接而不降低效能
- **SC-005**: 參數驗證能夠捕捉並正確回報 100% 的無效參數組合
- **SC-006**: 當搜尋服務發生錯誤時,MCP 伺服器保持運行並能處理後續請求(可用性 99.9%)
- **SC-007**: 90% 的 MCP 工具調用在 3 秒內完成(不包含網路延遲)
- **SC-008**: 錯誤訊息清晰度評分達到 4.5 分以上(5 分制,由開發團隊評估)

## 假設

- 假設使用者已經安裝並配置了相容的 MCP 客戶端(如 Claude Desktop)
- 假設現有的 YouTube 搜尋 API 功能運作正常且穩定
- 假設系統部署環境具備執行 MCP 伺服器所需的資源(記憶體、CPU、網路)
- 假設使用標準的 MCP Python SDK 進行開發
- 假設 MCP 伺服器與現有 FastAPI 服務可以共存於同一環境
- 假設使用者對 MCP 協定有基本了解,知道如何配置和使用 MCP 伺服器
- 假設快取服務(Redis)可選,MCP 功能在沒有快取時仍能正常運作

## 相依性

- 現有的 YouTube 搜尋 API 功能(specs/001-youtube-search-api)必須正常運作
- MCP Python SDK 需要安裝和配置
- 現有的日誌系統需要能夠記錄 MCP 相關事件
- 現有的錯誤處理機制需要能夠整合到 MCP 工具中
- 配置管理系統需要擴充以支援 MCP 相關設定

## 範圍外

本功能**不包含**以下項目:

- 不包含 MCP 客戶端開發(使用現有的客戶端如 Claude Desktop)
- 不包含修改或擴充現有 YouTube 搜尋 API 的功能(只封裝現有功能)
- 不包含開發新的搜尋工具(只整合現有的 YouTube 搜尋)
- 不包含 MCP 伺服器的 GUI 管理介面
- 不包含 MCP 工具的使用量統計或分析功能
- 不包含多租戶或使用者認證功能
- 不包含 MCP 工具的版本管理或回滾機制
- 不包含自動化測試 MCP 客戶端整合(只測試伺服器端邏輯)

## 澄清

### Session 2025-12-07

- **Q1: MCP 伺服器部署架構** → **A: FastAPI 整合 (StreamableHTTPSessionManager)**
  - 理由：官方 MCP Python SDK 提供 StreamableHTTPSessionManager，可透過 FastAPI 的 Starlette 框架無縫整合
  - 技術決策：使用 MCP 官方 SDK 的 StreamableHTTP 傳輸層，避免自訂實現

- **Q2: MCP 支援的工具集合** → **A: youtube_search + 可擴展的工具框架**
  - 理由：現有服務層已採用模組化設計（services/search.py, services/scraper.py），應延續此模式
  - 額外限制：不使用 YouTube Data API，維持爬蟲方式實現以控制成本
  - 架構設計：提供工具註冊機制，為未來添加其他工具預留接口

- **Q3: MCP 工具的超時和重試策略** → **A: 環境變數可配置的固定超時 + 重試**
  - MCP_SEARCH_TIMEOUT：預設 15 秒，允許使用者自行調整
  - MCP_SEARCH_RETRIES：預設 3 次，允許使用者自行調整
  - 理由：提供靈活性以應對不同網路環境，避免 AI 助手長時間等待

- **Q4: 初期開發範圍（MVP 定義）** → **A: P1 + P2 功能**
  - P1 功能：MCP 伺服器基礎功能 + YouTube 搜尋工具
  - P2 功能：完整的參數驗證與錯誤處理（FR-006 至 FR-009）
  - P3 功能：延後到後續迭代，初期使用合理預設值
  - 理由：參數驗證和錯誤處理是核心品質要求，應在 MVP 中實現
