services:
    api:
        build: .
        ports:
            - "8810:8000"
        environment:
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - REDIS_PASSWORD=${REDIS_PASSWORD:-} # Optional: set via .env or remove if no password
            - REDIS_ENABLED=true
            - API_LOG_LEVEL=info
        depends_on:
            redis:
                condition: service_healthy
        restart: unless-stopped

    redis:
        image: redis:7-alpine
        command: >
            sh -c '
            if [ -n "$$REDIS_PASSWORD" ]; then
              redis-server --requirepass "$$REDIS_PASSWORD"
            else
              redis-server
            fi
            '
        environment:
            - REDIS_PASSWORD=${REDIS_PASSWORD:-} # Optional: set via .env
        ports:
            - "6379:6379"
        healthcheck:
            test: >
                sh -c '
                if [ -n "$$REDIS_PASSWORD" ]; then
                  redis-cli -a "$$REDIS_PASSWORD" ping
                else
                  redis-cli ping
                fi
                '
            interval: 10s
            timeout: 3s
            retries: 3
        restart: unless-stopped
        volumes:
            - redis-data:/data

volumes:
    redis-data:
